c['www']['ui_default_config'] = { 
    'Waterfall.number_background_waterfall': True,
    'Waterfall.show_builders_without_builds': True,
    'Waterfall.show_old_builders': True,
    'Grid.fullChanges': True,
    'Grid.leftToRight': True,
    'Builders.show_old_builders': True,
    'Builders.show_workers_name': True,
    'Workers.show_old_workers': True,
    'Workers.showWorkerBuilders': True,
}

from buildbot.www.auth import AuthService
from buildbot.www.hooks import AuthenticatedResource

# --- Supercharged default UI config ---
SUPERCHARGED_UI_DEFAULTS = {
    'Waterfall.number_background_waterfall': True,
    'Waterfall.show_builders_without_builds': True,
    'Waterfall.show_old_builders': True,
    'Waterfall.show_timestamps': True,
    'Waterfall.show_completion_status': True,
    'Waterfall.highlight_failed_builds': True,
    'Waterfall.group_by_category': True,
    'Grid.fullChanges': True,
    'Grid.leftToRight': True,
    'Grid.showTimes': True,
    'Grid.showStatusForAll': True,
    'Grid.highlight_failures': True,
    'Grid.collapse_inactive_builders': True,
    'Grid.group_by_category': True,
    'Builders.show_old_builders': True,
    'Builders.show_workers_name': True,
    'Builders.group_by_category': True,
    'Builders.highlight_failed_builds': True,
    'Builders.collapse_inactive': False,
    'Workers.show_old_workers': True,
    'Workers.showWorkerBuilders': True,
    'Workers.show_status': True,
    'Workers.highlight_inactive': True,
    'Workers.collapse_inactive': False,
    'Console.showFullLog': False,
    'Console.autoScroll': True,
    'Console.showTimestamps': True,
    'Console.highlight_errors': True,
    'Theme': 'dark',
    'autoRefresh': 15,
    'showHiddenBuilders': True,
    'showHiddenWorkers': True,
    'showAllBuilds': True,
    'highlightActiveBuilds': True,
}

# --- Role overrides ---
ROLE_OVERRIDES = {
    'admin': {
        'Console.showFullLog': True,
        'autoRefresh': 10,
        'Grid.collapse_inactive_builders': False,
        'Builders.collapse_inactive': False,
        'Workers.collapse_inactive': False,
        'Theme': 'dark',
    },
    'user': {
        'Console.showFullLog': False,
        'autoRefresh': 30,
        'Grid.collapse_inactive_builders': True,
        'Builders.collapse_inactive': True,
        'Workers.collapse_inactive': True,
        'Theme': 'light',
    }
}

# --- Function to get UI config dynamically ---
def get_ui_config_for_user(username: str, custom_overrides=None):
    """
    Merge defaults with role-based and optional per-user overrides.
    """
    # Simple role mapping (you can make it a DB lookup or more complex)
    role = 'admin' if username in ['admin', 'ci_manager'] else 'user'

    config = SUPERCHARGED_UI_DEFAULTS.copy()
    config.update(ROLE_OVERRIDES.get(role, {}))
    if custom_overrides:
        config.update(custom_overrides)
    return config

# --- Hook into Buildbot www plugin ---
class DynamicUIResource(AuthenticatedResource):
    """
    Overrides the UI defaults based on authenticated user.
    """
    def get_ui_default_config(self, request):
        user = request.user
        if user:
            username = user.username
        else:
            username = 'guest'
        return get_ui_config_for_user(username)

# --- Usage in Buildbot config ---
c['www']['ui_default_config'] = DynamicUIResource()
