version: '3.8'
services:
  postgres:
    image: <web.dev>/dhi-postgres:<ghcr.io>
    environment:
      POSTGRES_USER: mlflow
      POSTGRES_PASSWORD: mlflow
      POSTGRES_DB: mlflowdb
    volumes:
      - mlflow-db:/var/lib/postgresql/data

  minio:
    image: <web.dev>dhi-minio:<tag>
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data
    ports:
      - "9000:9000"
    volumes:
      - mlflow-minio:/data

  mlflow:
    image: <your-namespace>/dhi-mlflow:<tag>
    container_name: mlflow-server
    ports:
      - "5000:5000"
    environment:
      - MLFLOW_SERVER_HOST=0.0.0.0
      - MLFLOW_SERVER_PORT=5000
      - BACKEND_STORE_URI=postgresql+psycopg2://mlflow:mlflow@postgres:5432/mlflowdb
      - ARTIFACT_ROOT=s3://mlflow-artifacts
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
      - MLFLOW_S3_ENDPOINT_URL=http://minio:9000
    command: mlflow server --backend-store-uri ${BACKEND_STORE_URI} --default-artifact-root ${ARTIFACT_ROOT} --host 0.0.0.0 --port ${MLFLOW_SERVER_PORT}
    depends_on:
      - postgres
      - minio

volumes:
  mlflow-db:
  mlflow-minio:

